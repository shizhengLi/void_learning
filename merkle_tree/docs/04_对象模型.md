# 对象模型文档

## 概述

`src/objects/` 模块实现了Git风格的对象模型，包括Blob、Tree、Commit和Tag四种对象类型。这些对象共同构成了Merkle Tree的数据结构。

## 对象类型

### 1. Blob对象

Blob对象用于存储文件内容，是Merkle Tree的叶子节点。

#### 主要特性
- 存储原始文件内容（字节数据）
- 计算内容哈希值
- 支持序列化和反序列化
- 支持文件读写操作

#### 核心方法
- `__init__(content)`: 初始化Blob对象
- `hash`: 获取对象哈希值
- `size`: 获取对象大小
- `get_content()`: 获取内容
- `get_content_string()`: 获取字符串内容
- `serialize()`: 序列化对象
- `deserialize(data)`: 反序列化对象
- `from_file(file_path)`: 从文件创建
- `to_file(file_path)`: 写入文件

#### 使用示例
```python
from objects.blob import Blob

# 从字符串创建
blob = Blob("Hello, World!")
print(f"哈希: {blob.hash}")

# 从文件创建
blob = Blob.from_file("test.txt")
blob.to_file("output.txt")
```

### 2. Tree对象

Tree对象用于存储目录结构，是Merkle Tree的内部节点。

#### 主要特性
- 存储目录结构信息
- 包含Blob和Tree子对象
- 支持递归目录遍历
- 维护对象间的层次关系

#### TreeEntry数据结构
```python
@dataclass
class TreeEntry:
    mode: str      # 文件模式（100644, 100755, 040000）
    obj_type: str  # 对象类型（blob, tree）
    hash: str      # 对象哈希
    name: str      # 文件/目录名
```

#### 核心方法
- `add_entry(entry)`: 添加条目
- `add_blob(blob, name, mode)`: 添加Blob对象
- `add_tree(tree, name, mode)`: 添加Tree对象
- `remove_entry(name)`: 移除条目
- `get_entry(name)`: 获取条目
- `get_entries()`: 获取所有条目
- `from_directory(directory)`: 从目录创建
- `serialize()`: 序列化对象
- `deserialize(data)`: 反序列化对象

#### 使用示例
```python
from objects.tree import Tree
from objects.blob import Blob

# 创建Tree对象
tree = Tree()

# 添加文件
blob1 = Blob("File 1 content")
blob2 = Blob("File 2 content")
tree.add_blob(blob1, "file1.txt")
tree.add_blob(blob2, "file2.txt")

# 从目录创建
tree = Tree.from_directory("project_directory")
```

### 3. Commit对象

Commit对象用于存储提交信息，是Merkle Tree的根节点。

#### 主要特性
- 存储提交元数据
- 维护提交历史链
- 关联Tree对象
- 支持父子关系

#### 核心属性
- `tree_hash`: 关联的Tree对象哈希
- `parent_hash`: 父Commit对象哈希
- `author`: 作者信息
- `committer`: 提交者信息
- `message`: 提交消息
- `timestamp`: 提交时间

#### 核心方法
- `set_tree(tree)`: 设置关联的Tree对象
- `set_parent(parent_commit)`: 设置父Commit对象
- `get_parent_hash()`: 获取父Commit哈希
- `is_initial_commit()`: 判断是否为初始提交
- `serialize()`: 序列化对象
- `deserialize(data)`: 反序列化对象

#### 使用示例
```python
from objects.commit import Commit
from objects.tree import Tree
from datetime import datetime

# 创建Commit对象
commit = Commit(
    tree_hash=tree.hash,
    author="Author <author@example.com>",
    committer="Committer <committer@example.com>",
    message="Initial commit",
    timestamp=datetime.now()
)

# 设置父子关系
commit2 = Commit(
    tree_hash=tree.hash,
    parent_hash=commit.hash,
    author="Author <author@example.com>",
    committer="Committer <committer@example.com>",
    message="Second commit"
)
```

### 4. Tag对象

Tag对象用于存储标签信息，用于标记特定的Commit。

#### 主要特性
- 标记特定的提交
- 存储标签元数据
- 支持版本标记
- 可包含标签消息

#### 核心属性
- `tag_name`: 标签名称
- `target_hash`: 目标对象哈希
- `target_type`: 目标对象类型
- `tagger`: 标签创建者
- `message`: 标签消息
- `timestamp`: 创建时间

#### 核心方法
- `set_target(commit)`: 设置目标Commit对象
- `serialize()`: 序列化对象
- `deserialize(data)`: 反序列化对象

#### 使用示例
```python
from objects.tag import Tag
from datetime import datetime

# 创建Tag对象
tag = Tag(
    tag_name="v1.0.0",
    target_hash=commit.hash,
    target_type="commit",
    tagger="Tagger <tagger@example.com>",
    message="Version 1.0.0 release",
    timestamp=datetime.now()
)
```

## Merkle Tree结构

### 层次关系
```
Commit (根节点)
  |
  Tree (目录结构)
  ├── Blob (文件内容)
  ├── Blob (文件内容)
  └── Tree (子目录)
      ├── Blob (文件内容)
      └── Blob (文件内容)
```

### 哈希计算
1. **Blob哈希**: 基于文件内容计算
2. **Tree哈希**: 基于条目列表计算
3. **Commit哈希**: 基于提交信息计算
4. **Tag哈希**: 基于标签信息计算

### 完整性保证
- 任何对象的修改都会导致哈希值变化
- 父对象的哈希依赖于子对象的哈希
- 根对象的哈希保证整个数据结构的完整性

## 序列化格式

### Git对象格式
所有对象都遵循统一的格式：
```
<type> <size>\0<content>
```

### Blob对象格式
```
blob <size>\0<file_content>
```

### Tree对象格式
```
tree <size>\0<mode> <type> <hash>\t<name>\n...
```

### Commit对象格式
```
commit <size>\0tree <hash>\n[parent <hash>\n]author <info>\ncommitter <info>\n\n<message>
```

### Tag对象格式
```
tag <size>\0object <hash>\ntype <type>\ntag <name>\ntagger <info>\n\n<message>
```

## 在版本控制中的作用

### 1. 数据完整性
- 每个对象都有唯一的哈希标识
- 哈希值保证数据不被篡改
- 支持快速验证数据完整性

### 2. 增量存储
- 相同内容的对象只存储一份
- 支持对象复用和去重
- 节省存储空间

### 3. 历史追踪
- Commit对象形成历史链
- 支持版本回溯和比较
- 提供完整的变更历史

### 4. 高效同步
- 通过哈希比较快速识别变更
- 支持增量同步和更新
- 优化网络传输效率

## 测试验证

所有对象都经过了完整的测试验证：

```python
# 测试Blob对象
blob = Blob("test content")
assert blob.hash == HashCalculator.hash_object('blob', "test content")

# 测试Tree对象
tree = Tree()
tree.add_blob(blob, "test.txt")
assert len(tree.entries) == 1

# 测试Commit对象
commit = Commit(tree_hash=tree.hash, message="test")
assert commit.tree_hash == tree.hash

# 测试Tag对象
tag = Tag(tag_name="v1.0", target_hash=commit.hash)
assert tag.target_hash == commit.hash
```

## 注意事项

1. **哈希碰撞**: 使用SHA-1算法，存在理论碰撞风险
2. **内存使用**: 大文件需要注意内存管理
3. **路径处理**: 文件路径需要正确处理
4. **异常处理**: 需要适当的错误处理机制
5. **并发访问**: 多线程环境需要考虑线程安全