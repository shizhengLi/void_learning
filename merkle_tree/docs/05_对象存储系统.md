# 对象存储系统文档

## 概述

`src/core/` 模块实现了完整的对象存储系统，包括对象数据库、索引管理和Merkle Tree算法。这些组件共同构成了版本控制系统的核心存储层。

## 核心组件

### 1. ObjectDatabase（对象数据库）

对象数据库负责存储和管理所有Git对象，采用Git风格的存储方式。

#### 主要特性
- Git风格的对象存储（前两个字符作为目录名）
- 对象压缩存储（使用zlib压缩）
- 完整性验证和错误恢复
- 支持批量操作和统计信息

#### 核心方法
- `store_object(obj)`: 存储对象
- `get_object(hash)`: 获取对象
- `object_exists(hash)`: 检查对象是否存在
- `delete_object(hash)`: 删除对象
- `list_objects(type)`: 列出对象
- `get_object_info(hash)`: 获取对象信息
- `get_stats()`: 获取统计信息
- `verify_integrity()`: 验证完整性

#### 使用示例
```python
from core.repository import ObjectDatabase
from objects.blob import Blob

# 创建对象数据库
odb = ObjectDatabase('/path/to/repo')

# 存储对象
blob = Blob('Hello, World!')
hash_value = odb.store_object(blob)

# 获取对象
retrieved_blob = odb.get_object(hash_value)

# 检查对象是否存在
exists = odb.object_exists(hash_value)

# 获取统计信息
stats = odb.get_stats()
print(f"总对象数: {stats['total_objects']}")
print(f"按类型分布: {stats['objects_by_type']}")
```

#### 存储结构
```
.pygit/objects/
├── ab/
│   └── cdef1234...  # 对象文件
├── cd/
│   └── ef56789a...  # 对象文件
└── ...
```

### 2. Index（索引管理）

索引管理器负责跟踪工作区和暂存区的文件状态，是Git暂存区的核心实现。

#### 主要特性
- 文件状态跟踪（修改时间、大小、哈希）
- 暂存区管理
- 文件变更检测
- 索引完整性验证

#### IndexEntry数据结构
```python
@dataclass
class IndexEntry:
    path: str        # 文件路径
    mode: str        # 文件模式
    blob_hash: str   # Blob对象哈希
    size: int        # 文件大小
    mtime: float     # 修改时间
    stage: int       # 暂存区阶段
```

#### 核心方法
- `add_file(path, mode)`: 添加文件到索引
- `remove_file(path)`: 从索引移除文件
- `get_entry(path)`: 获取索引条目
- `is_file_modified(path)`: 检查文件是否修改
- `get_modified_files()`: 获取修改的文件
- `get_untracked_files()`: 获取未跟踪的文件
- `get_staged_files()`: 获取暂存的文件
- `update_entry(path)`: 更新索引条目
- `get_stats()`: 获取统计信息
- `validate()`: 验证索引完整性

#### 使用示例
```python
from core.index import Index

# 创建索引管理器
index = Index('/path/to/repo')

# 添加文件到索引
entry = index.add_file('test.txt', '100644')

# 检查文件状态
is_modified = index.is_file_modified('test.txt')

# 获取修改的文件
modified_files = index.get_modified_files()

# 获取未跟踪的文件
untracked_files = index.get_untracked_files()

# 更新索引条目
updated_entry = index.update_entry('test.txt')
```

#### 索引文件格式
索引文件使用JSON格式存储：
```json
{
  "version": 1,
  "entries": [
    {
      "path": "test.txt",
      "mode": "100644",
      "blob_hash": "abc123...",
      "size": 1024,
      "mtime": 1234567890.0,
      "stage": 0
    }
  ]
}
```

### 3. MerkleTree（Merkle Tree算法）

MerkleTree管理器实现了Merkle Tree的核心算法，用于构建和验证版本控制树结构。

#### 主要特性
- 从目录构建Merkle Tree
- 递归树结构构建
- Tree差异比较
- 变更文件检测
- 完整性验证

#### 核心方法
- `build_tree_from_directory(dir, patterns)`: 从目录构建Tree
- `build_tree_from_files(files)`: 从文件列表构建Tree
- `compare_trees(tree1, tree2)`: 比较两个Tree
- `find_changed_files(old_tree, new_tree)`: 查找变更文件
- `get_file_hash(tree, path)`: 获取文件哈希
- `list_files(tree)`: 列出所有文件
- `get_tree_statistics(tree)`: 获取Tree统计信息
- `validate_tree_integrity(tree)`: 验证Tree完整性
- `create_commit(tree, message, parent)`: 创建Commit

#### 使用示例
```python
from core.merkle import MerkleTree

# 创建MerkleTree管理器
merkle_tree = MerkleTree('/path/to/repo')

# 从目录构建Tree
tree = merkle_tree.build_tree_from_directory('project')

# 获取Tree统计信息
stats = merkle_tree.get_tree_statistics(tree)
print(f"文件总数: {stats['total_files']}")
print(f"目录总数: {stats['total_directories']}")

# 比较两个Tree
differences = merkle_tree.compare_trees(tree1, tree2)
print(f"新增文件: {differences['added']}")
print(f"删除文件: {differences['removed']}")
print(f"修改文件: {differences['modified']}")

# 创建Commit
commit = merkle_tree.create_commit(tree, 'Initial commit')
```

## 系统架构

### 数据流向
```
工作区 → 索引 → 对象数据库 → Merkle Tree → Commit
```

### 组件关系
1. **索引管理**：跟踪工作区文件状态
2. **对象数据库**：存储所有对象数据
3. **Merkle Tree**：构建版本控制树结构
4. **Commit**：维护版本历史

### 完整性保证
- 对象哈希验证
- 索引一致性检查
- Tree完整性验证
- 数据压缩和校验

## 性能优化

### 1. 对象存储优化
- 分目录存储避免单目录文件过多
- zlib压缩减少存储空间
- 哈希去重避免重复存储

### 2. 索引优化
- 内存缓存提高访问速度
- 增量更新减少计算开销
- 快速变更检测算法

### 3. Merkle Tree优化
- 递归构建算法
- 增量比较算法
- 哈希缓存机制

## 错误处理

### 1. 对象数据库错误
- 文件不存在异常
- 数据损坏检测
- 磁盘空间不足处理

### 2. 索引错误
- 索引文件损坏恢复
- 文件状态不一致处理
- 并发访问冲突

### 3. Merkle Tree错误
- 树结构完整性验证
- 循环引用检测
- 路径遍历安全

## 测试验证

### 1. 单元测试
- 对象存储和检索
- 索引添加和删除
- Tree构建和比较

### 2. 集成测试
- 完整工作流程
- 数据一致性验证
- 性能基准测试

### 3. 边界测试
- 大文件处理
- 深层目录结构
- 异常情况处理

## 使用建议

### 1. 最佳实践
- 定期验证对象完整性
- 及时清理无用对象
- 监控存储空间使用

### 2. 性能建议
- 批量操作优于单条操作
- 合理使用索引缓存
- 避免频繁的Tree重建

### 3. 安全建议
- 定期备份对象数据库
- 验证数据完整性
- 监控异常访问模式

## 扩展性

### 1. 存储后端
- 支持多种存储后端
- 分布式存储支持
- 云存储集成

### 2. 算法优化
- 更高效的哈希算法
- 增量同步算法
- 压缩算法优化

### 3. 功能扩展
- 分支管理支持
- 合并算法实现
- 远程仓库支持

这个对象存储系统为版本控制提供了坚实的基础，支持高效的数据存储、快速的状态跟踪和可靠的完整性验证。